---
title: 'Comparing the Res/Exh signatures from CD8, CD4, and NK cells'
author: 
  - name: 'Momeneh (Sepideh) Foroutan'
    affiliation: 'Huntington Cancer Immunotherapy Lab'
    url: https://www.monash.edu/discovery-institute/huntington-lab
date: '12-06-2020'
output:
  rmdformats::readthedown:
    fig_width: 12
    fig_height: 6
    gallery: TRUE
    highlight: tango
    lightbox: TRUE
    self_contained: TRUE
    thumbnails: FALSE
    number_sections: TRUE	
    toc_depth: 4
    use_bookdown: TRUE
    code_folding: hide
  html_document2:
    df_print: paged
params:
  update_date: !r paste("Last updated on:", Sys.Date() )
editor_options: 
  chunk_output_type: inline
---
`r params$update_date`

<style>
body {
text-align: justify}
</style>


```{r knitr_init, echo=FALSE, results="asis", cache=FALSE}
library(knitr)
library(rmdformats)

options(max.print = "75")
opts_chunk$set(
  # echo = FALSE,
  cache = TRUE,
  # prompt = FALSE,
  # tidy = FALSE,
  comment = NA,
  message = FALSE,
  warning = FALSE,
  # results = FALSE,
  root.dir = normalizePath("."))
opts_knit$set(width = 65)
```

# Set up and overview
In this document, we work on the NK and T cells from the Zhang Smart-seq2 single cell data. We visualise the cell annotations and Res/Exh signature scores in the combined data. We then visulaise the expression of marker genes in the CCLE and LCM CRC data. Finally, we obtain signatures for proliferative Exh cells by comparing these cells to non-proliferative Exh cells in each cell type, separately. 
```{r file set up, echo=F, results=F, message=F, warning=F}
mainDir <- getwd()
outPath <- "../output/CompareSigs/"
figPath <- "../figure/CompareSigs/"
dataPath <- "../data/"
scriptPath <- "../script/"

tpmPath <- "../data/GSE146771_Zhang_CRC/"
hpaGoUniprotPath <- "../data/HPA_GO_Uniprot/"
sigPath <- "../data/Signatures_literature/"
ccleLcmPath <- "../data/CCLE_LCM/"

ifelse(!dir.exists(file.path(mainDir, outPath)), dir.create(file.path(mainDir, outPath)), FALSE)
ifelse(!dir.exists(file.path(mainDir, figPath)), dir.create(file.path(mainDir, figPath)), FALSE)
ifelse(!dir.exists(file.path(mainDir, dataPath)), dir.create(file.path(mainDir, dataPath)), FALSE)
ifelse(!dir.exists(file.path(mainDir, scriptPath)), dir.create(file.path(mainDir, scriptPath)), FALSE)

library(tidyverse)
library(RColorBrewer)
library(SingleCellExperiment)
library(Seurat)

options(digits = 3)

equal_breaks <- function(n = nBreak, s = scalingFactor, ...){
  function(x){
    # rescaling
    d <- s * diff(range(x)) / (1+2*s)
    round( seq(min(x)+d, max(x)-d, length=n), 2)
  }
}

nBreak = 3
scalingFactor = 0.05

textSize <- 1.2

currentTheme <- theme_bw() +
  theme(
    # panel.background = element_blank()
    axis.title = element_text(size = rel(textSize)),
    axis.text = element_text(angle = 0, size = rel(textSize)),
    # strip.background = element_rect(colour = "#f0f0f0", fill = "#f0f0f0"),
    strip.text = element_text(size = rel(textSize)),
    axis.line = element_line(colour = "black", size = 0.5),
    legend.position = 'top',
    legend.title = element_text(size = rel(textSize), face = "italic"),
    legend.text = element_text(size = rel(textSize)),
    legend.key.size = unit(1, 'lines'),
    ## increase the line space
    plot.title = element_text(
      face = "bold",
      size = rel(textSize),
      hjust = 0.5
    )
  )

cols <-  c(
  brewer.pal(8, "Dark2")[-5],
  brewer.pal(10, "Paired"),
  brewer.pal(12, "Set3"),
  brewer.pal(9, "Blues")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Oranges")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Greens")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Purples")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Reds")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Greys")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "BuGn")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "PuRd")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "BuPu")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "YlGn")[c(8, 3, 7, 4, 6, 9, 5)])


source(paste0(scriptPath, "visReduction_function.R"))
```

## Read signatures
These include marker genes as well as proliferation and TGFb-induced TRM signature.
```{r}
outPathCD8 <- "../output/CD8/"
outPathCD4 <- "../output/CD4/"
outPathNK <- "../output/NK/"


cd8Sigs <-
  read.table(
    paste0(outPathCD8, "ResExhMarkers_CD8_CLs_LCM.txt"),
    header = T,
    sep = "\t",
    stringsAsFactors = F,
    check.names = F
  )


cd4Sigs <-
  read.table(
    paste0(outPathCD4, "ResExhMarkers_CD4_CLs_LCM.txt"),
    header = T,
    sep = "\t",
    stringsAsFactors = F,
    check.names = F
  )


nkSigs <-
  read.table(
    paste0(outPathNK, "ResExhMarkers_NK_CLs_LCM.txt"),
    header = T,
    sep = "\t",
    stringsAsFactors = F,
    check.names = F
  )

nkSigs$Cell.Type <- "NK"
cd8Sigs$Cell.Type <- "CD8"
cd4Sigs$Cell.Type <- "CD4"

allMarkers <- rbind(nkSigs, cd8Sigs, cd4Sigs)


exhData0 <- allMarkers[allMarkers$Marker == "Exh", ]
trmData0 <- allMarkers[allMarkers$Marker == "Res", ]

##---- generate a new Exh and Res signature by combining 
## all the Exh genes together and all the Res genes together
All_Exh <-  unique(exhData0$gene)
All_Res <-  unique(trmData0$gene)

exhData_CanPass0 <- exhData0[exhData0$CancerPass, ]
trmData_CanPass0 <- trmData0[trmData0$CancerPass, ]

##------------ Marker genes
CD8_ExhMarker <- cd8Sigs$gene[cd8Sigs$Marker == "Exh"]
CD8_ResMarker <- cd8Sigs$gene[cd8Sigs$Marker == "Res"]

CD4_ExhMarker <- cd4Sigs$gene[cd4Sigs$Marker == "Exh"]
CD4_ResMarker <- cd4Sigs$gene[cd4Sigs$Marker == "Res"]

NK_ExhMarker <- nkSigs$gene[nkSigs$Marker == "Exh"]
NK_ResMarker <- nkSigs$gene[nkSigs$Marker == "Res"]


## Read other signatures
prolifTGFbTRM <- readRDS(paste0(sigPath, "Prolif_TrmTGFb_signature_list_literature.RDS"))

Proliferation <- prolifTGFbTRM$Proliferation_imsig
TRM_TGFb_Unstim_Up <- prolifTGFbTRM$TRM_TGFb_Unstim_Up


##----- Generate a list of all signatures that we want to use for scoring later
AllSigs <- list(
  CD8_Exh = CD8_ExhMarker,
  CD8_Res = CD8_ResMarker,
  
  CD4_Exh = CD4_ExhMarker, 
  CD4_Res = CD4_ResMarker, 
  
  NK_Exh = NK_ExhMarker,
  NK_Res = NK_ResMarker,
  
  All_Exh = All_Exh,
  All_Res = All_Res, 
  
  Proliferation = Proliferation, 
  TRM_TGFb_Unstim_Up = TRM_TGFb_Unstim_Up
  
)

AllSigsGeneSet <- lapply(AllSigs, GSEABase::GeneSet)

AllSigsGeneSetName <- lapply(names(AllSigsGeneSet), function(x) {
  currentSig <- AllSigsGeneSet[[x]]
  GSEABase::setName(currentSig) <- x
  return(currentSig)
})

names(AllSigsGeneSetName) <- names(AllSigsGeneSet)

AllSigsCollection <- GSEABase::GeneSetCollection(AllSigsGeneSetName)

scoreNames <- names(AllSigsGeneSet)
```

### Merge initial Res and Exh signatures
Here we merge all initial signatures of Res and Exh (Supp Table 1 in the paper)
```{r}
cd8Init <- readRDS(paste0(outPathCD8, "Initial_Res_Exh_Genes_CD8_Corr_20200928.RDS"))
cd4Init <- readRDS(paste0(outPathCD4, "Initial_Res_Exh_Genes_CD4_Corr_20200928.RDS"))
nkInit <- readRDS(paste0(outPathNK, "Initial_Res_Exh_Genes_NK_Corr_20200928.RDS"))

cd8InitData <- data.frame(Genes = unlist(cd8Init))
cd8InitData$CellType <- "CD8"

cd4InitData <- data.frame(Genes = unlist(cd4Init))
cd4InitData$CellType <- "CD4"

nkInitData <- data.frame(Genes = unlist(nkInit))
nkInitData$CellType <- "NK"


initData <- data.frame(rbind(cd8InitData, cd4InitData, nkInitData))
initData$Markers <- "Res"
initData$Markers[grepl("tex", rownames(initData))] <- "Exh"
initData <- initData[! grepl("comGenes", rownames(initData)), ]

table(initData$Markers, initData$CellType)
  #     CD4 CD8 NK
  # Exh  34  23 22
  # Res  39  29 42

# write.csv(initData,
#           paste0(outPath, "InitialSignatures_AllMarkers.csv"),
#           row.names = F)
```

## Read GPCRs and TFs
In order to annotate genes based on whether or not they are TFs, GPCR or associated with GPCR signalling, we use the human protein atlas and get the GPCR and TF annotations from there. For GPCR, we also downloaded the GPCR related genes from QuickGO and selected the genes annotated as gpcr in uniprot too. Supp Table 7 in the paper includes the list of TFs and GPCRs that are used here (see the last two commented lines of codes for exporting these data).
```{r}
hpa <- read.delim(paste0(hpaGoUniprotPath, "proteinatlas.tsv"), header = T)

GPCRs <-
  hpa[grepl("coupled", hpa$Gene.description, ignore.case = T) |
        grepl("coupled", hpa$Protein.class, ignore.case = T), c(
          "Gene",
          "Ensembl",
          "Protein.class",
          "Gene.description",
          "Uniprot" ,
          "Blood.RNA...NK.cell..NX."
        )]

GPCRs <- GPCRs[order(GPCRs$Blood.RNA...NK.cell..NX., decreasing = T), ]


TFs <- hpa[grepl("Transcription factor", hpa$Gene.description, ignore.case = T) |
        grepl("Transcription factor", hpa$Protein.class, ignore.case = T), c(
          "Gene",
          "Ensembl",
          "Protein.class",
          "Gene.description",
          "Uniprot" ,
          "Blood.RNA...NK.cell..NX."
        )]
  
TFs <- TFs[order(TFs$Blood.RNA...NK.cell..NX., decreasing = T), ]
 
  
go <- read.delim(paste0(hpaGoUniprotPath, "QuickGO-annotations-1592213989958-20200615.tsv"), header = T)

go <- unique(go$SYMBOL)

## 780 genes common between these
# length(intersect(GPCRs$Gene, go))

## 2035 unique genes
gpr <- unique(c(as.character(GPCRs$Gene), as.character(go)))
gpr <- as.character(gpr)
gpr <- gpr[! grepl("Homo sapiens", gpr)]
gpr <- gpr[! grepl("human", gpr)]
## MGRF

uniprot <- read.csv(paste0(hpaGoUniprotPath, "7tmrlist_uniprot.csv"), 
                    stringsAsFactors = F)

uniprot <- uniprot[grepl("HUMAN", uniprot$genes), ]
uniprot <- sapply(uniprot$genes, function(x){ unlist(strsplit(x, "_"))[1]})

uniprot <- as.character(uniprot)


tars <- read.csv(paste0(hpaGoUniprotPath, "targets_and_families.csv"), 
                 stringsAsFactors = F)

tars <- tars$HGNC.symbol[tars$Type == "gpcr"]
tars <- tars[! tars == ""]
tars <- tars[!duplicated(tars)]

gpr <- unique(c(gpr, uniprot, tars))

# write.table(gpr, paste0(outPath, "GPCRs_GPCR-signallingPathway-GO-associatedGenes.csv"), row.names = F)
# write.table(TFs$Gene, paste0(outPath, "TFs_Genes.csv"), row.names = F)
```


# Zhang Smart-seq T and NK cells
Here we generated a Seurat object of the Zhang Smart-seq data that includes CD8, CD4 and NK cells altogether and perform standrad Seurat pipeline (commented code below); now, we read the Seurat object for futher analysis. 
```{r, cache = T}

# crcSmart <-
#    data.table::fread(
#     paste0(tpmPath, "GSE146771_CRC.Leukocyte.Smart-seq2.TPM.txt")
#   )
# 
# rnames <- crcSmart$V1
# crcSmart <- crcSmart[, 2:ncol(crcSmart)]
# rownames(crcSmart) <- rnames
# 
# crcSmart <- as.matrix(crcSmart)
# rownames(crcSmart) <- rnames

metaSmart <-
  read.table(
    paste0(tpmPath, "GSE146771_CRC.Leukocyte.Smart-seq2.Metadata.txt"),
    header = T,
    sep = "\t"
  )

metaSmart$Sub_Cluster <- as.character(metaSmart$Sub_Cluster)
metaSmart$Sub_Cluster <- sapply(metaSmart$Sub_Cluster, function(x){
  unlist(strsplit(x, "_"))[2]
})


immCells <- metaSmart$Sub_Cluster[grepl("CD8", metaSmart$Sub_Cluster)|
                                    grepl("NK", metaSmart$Sub_Cluster) |
                                    grepl("CD4", metaSmart$Sub_Cluster)|
                                    grepl("ILC3", metaSmart$Sub_Cluster)]

# cellCols <- cols[1:length(unique(immCells))]
# names(cellCols) <- unique(immCells)[order(unique(immCells))]

immCells <- immCells[order(immCells)]
immCellsFibbro <- c(immCells, metaSmart$Sub_Cluster[
                                    grepl("Myofib|CAF", metaSmart$Sub_Cluster)
                                      ])

cellCols <- cols[1:length(unique(immCellsFibbro))]
names(cellCols) <- unique(immCellsFibbro)


cd8Cols <- cellCols[grepl("CD8",
                          names(cellCols))]

cd4Cols <- cellCols[grepl("CD4",
                          names(cellCols))]

nkCols <- cellCols[grepl("NK-",
                          names(cellCols))]


# fibCols <- cellCols[grepl("Myofib|CAF",
#                           names(cellCols))]

myofibCol <-  cellCols[grepl("Myofib",
                          names(cellCols))]

cafCol <-  cellCols[grepl("CAF",
                          names(cellCols))]

# 
# subSmart <- crcSmart[,
#                      grepl("CD8-", metaSmart$Sub_Cluster) |
#                        grepl("CD4-", metaSmart$Sub_Cluster) |
#                        grepl("NK-", metaSmart$Sub_Cluster) |
#                        grepl("Myofib|CAF", metaSmart$Sub_Cluster)
#                      ]
# 
# subMetaSmart <- metaSmart[grepl("CD8-", metaSmart$Sub_Cluster) |
#                        grepl("CD4-", metaSmart$Sub_Cluster) |
#                        grepl("NK-", metaSmart$Sub_Cluster) |
#                        grepl("Myofib|CAF", metaSmart$Sub_Cluster) 
#                        , ]
# 
# rownames(subMetaSmart) <- subMetaSmart$CellName
# 
# all(subMetaSmart$CellName == colnames(subSmart))
# 
# subMetaSmart$Cell.Annotation <- sapply(subMetaSmart$Sub_Cluster, function(x){
#   unlist(strsplit(x, "-"))[1]
# })
# 
# ss <-
#   CreateSeuratObject(counts = subSmart,
#                      project = "Zhang_SmartSeq_T_NK_Fibro",
#                      meta.data = subMetaSmart,
#                      min.cells = 5)
# 
# ss[["percent.mt"]] <- PercentageFeatureSet(ss, pattern = "^MT-")
# 
# ss <- FindVariableFeatures(ss, selection.method = "vst", nfeatures = 2000)
# all.genes <- rownames(ss)
# ss <- ScaleData(ss, features = all.genes)
# ss <- RunPCA(ss, features = VariableFeatures(object = ss), verbose = F)
# # ElbowPlot(ss, ndims = 40)
# ss <- FindNeighbors(ss, dims = 1:20)
# ss <- FindClusters(ss, resolution = 0.8, random.seed = 20200915)
# ss <- RunUMAP(ss, dims = 1:20, n.neighbors = 30, min.dist = 0.3, seed.use = 20200915)
# 
# s.genes <- cc.genes$s.genes
# g2m.genes <- cc.genes$g2m.genes
# 
# ss <-
#   CellCycleScoring(
#     ss,
#     s.features = s.genes,
#     g2m.features = g2m.genes,
#     set.ident = FALSE
#   )
# 
# ss$MSI <- "MSS"
# ss$MSI[ss$Sample %in% c("P0123", "P0413", "P0825")] <- "MSI-H"


##------ Save data after UMAP

# saveRDS(ss, file = paste0(outPath, "DontPush/Zhang_SmartSeq_SeuratObj_T_NK_Fibro_UMAP.RDS"))

ss <- readRDS(paste0(outPath, "DontPush/Zhang_SmartSeq_SeuratObj_T_NK_Fibro_UMAP.RDS"))


# saveRDS(ss, file = paste0(outPath, "DontPush/Zhang_SmartSeq_SeuratObj_T_NK_20200928_UMAP.RDS"))
# 
# ss <- readRDS(paste0(outPath, "DontPush/Zhang_SmartSeq_SeuratObj_T_NK_20200928_UMAP.RDS"))

```

# Score T and NK cells
```{r, message = F, warning = F}
library(singscore)

rd <- rankGenes(as.matrix(GetAssayData(ss)))

ssScoresDisp <- multiScore(rd, 
                         upSetColc = AllSigsCollection, 
                         knownDirection = T, 
                         centerScore = F)
ssScores <-
  data.frame(t(ssScoresDisp$Scores),
             check.rows = F,
             check.names = F)


##----- Add these to annotation data:
ss@meta.data <- data.frame(ss@meta.data ,
                           ssScores,
                           check.names = F,
                           check.rows = F)

##----- Save data after UMAP and Scores

saveRDS(ss, file = paste0(outPath, "DontPush/Zhang_SmartSeq_SeuratObj_T_NK_Fibro_UMAP_Scores.RDS"))

# saveRDS(ss, file = paste0(outPath, "DontPush/Zhang_SmartSeq_SeuratObj_T_NK_20200928_UMAP_Scores.RDS"))
# ss <- readRDS(paste0(outPath, "DontPush/Zhang_SmartSeq_SeuratObj_T_NK_Fibro_UMAP_Scores.RDS"))
```

## UMAPs
We make sure that we replace Trm with Res to avoid confusion with the Trm signatures specific to CD8 T cells, as what we have are residency signatures in CD8, CD4 and NK cells.
```{r}
ss@meta.data$Global_Cluster[ss@meta.data$Global_Cluster == "ILC"] <- "NK cell"

cell_attrs <- ss[[]]
currentRedData <- ss@reductions[["umap"]]@cell.embeddings

cell_attrs$UMAP_1 <- currentRedData[, "UMAP_1"]
cell_attrs$UMAP_2 <- currentRedData[, "UMAP_2"]

```


### UMAP colored by annotation
We colour the UMAP based on cell annotations (provided by Zhang et al); these are related to the Supp. Figure 2 (panel A). 
```{r, fig.height=4.5, fig.width = 4}
annColumns <- c("Global_Cluster", "Tissue", "MSI")

pdf(
  # paste0(figPath, "UMAP_ZhangSmart_CellAnnot_TNK_20201029.pdf"),
  paste0(figPath, "UMAP_ZhangSmart_CellAnnot_TNK_Fibro.pdf"),
  height = 4.6,
  width = 4
)

for(i in annColumns){
  print(
    cell_attrs %>%
      ggplot(.,
             aes_string(
               x = "UMAP_1",
               y = "UMAP_2",
               color = i
             )) +
      geom_point(alpha = 0.8, cex = 0.4) +
      scale_color_manual(values = cols) +
      # theme_dark() +
      theme_bw() +
      theme(
        axis.text = element_text(size = 13, face = "plain") ,
        axis.title = element_text(size = 15, face = "plain"),
        legend.spacing = unit(1.5, "mm"),
        legend.position = "top",
        legend.key.width = unit(0.9, "cm"),
        legend.title = element_text(size = 13, face = "italic"),
        legend.text = element_text(size = 13)
      ) +
          guides(color = guide_legend(
    nrow = 4,
    override.aes = list(size = 3)))
  )
  
}
dev.off()
```


### UMAP coloured by scores
We colour the UMAP based on the Res and Exh scores; these are related to the Supp. Figure 2 (panel B) and the two left heatmaps in Supp Figure 3. 
```{r, fig.height=4.5, fig.width = 4}
pdf(
  # paste0(figPath, "UMAP_ZhangSmart_Scores_TNK_20201029.pdf"),
  # paste0(figPath, "UMAP_ZhangSmart_ResExh_Scores_TNK_20201214.pdf"),
  paste0(figPath, "UMAP_ZhangSmart_ResExh_Scores_TNK_Fibro.pdf"),
  height = 4.2,
  width = 4
)

selSigs <- c("CD8_Exh",
             "CD4_Exh",
             "NK_Exh",
             "CD8_Res",
             "CD4_Res",
             "NK_Res", 
             "All_Exh",  
             "All_Res")

for(i in selSigs){
  print(
    cell_attrs %>%
      arrange(!!sym(i)) %>%
      ggplot(.,
             aes_string(
               x = "UMAP_1",
               y = "UMAP_2",
               color = i
             )) +
      geom_point(alpha = 0.8, cex = 0.4) +
      scale_color_viridis_c() +
      theme_dark() +
      theme(
        axis.text = element_text(size = 13, face = "plain") ,
        axis.title = element_text(size = 15, face = "plain"),
        legend.spacing = unit(1.5, "mm"),
        legend.position = "top",
        legend.key.width = unit(0.9, "cm"),
        legend.title = element_text(size = 13, face = "italic"),
        legend.text = element_text(size = 13)
      )
  )
  
}
dev.off()
```

### UMAP coloured by GPR15
Reproducing teh right UMAP in Supp Figure 3.
```{r, fig.height=4.5, fig.width = 4}
exprData <- as.matrix(GetAssayData(ss))

gg <- c("GPR15")

exprData_Genes <-
  exprData[gg, , drop = F]

exprData_Genes <-
  data.frame(cell_attrs, data.frame(t(exprData_Genes)))


pdf(
  # paste0(figPath, "UMAP_Expr_GPR15.pdf"),
  paste0(figPath, "UMAP_Expr_GPR15_Fibro.pdf"),
  height = 4.2,
  width = 4
)

exprData_Genes %>%
  arrange(GPR15) %>%
ggplot(., aes(x = UMAP_1, y = UMAP_2, color = GPR15)) +
  geom_point(alpha = 0.8, cex = 0.4) +
  scale_color_continuous(type = "viridis") +
theme_dark() +
      theme(
        axis.text = element_text(size = 13, face = "plain") ,
        axis.title = element_text(size = 15, face = "plain"),
        legend.spacing = unit(1.5, "mm"),
        legend.position = "top",
        legend.key.width = unit(0.9, "cm"),
        legend.title = element_text(size = 13, face = "italic"),
        legend.text = element_text(size = 13)
      )
 
dev.off()

```



### UMAP coloured by signature genes
```{r, fig.height=4.5, fig.width = 4}
exprData <- as.matrix(GetAssayData(ss))

# gg <- All_Exh
# gg <- unique(exhData_CanPass0$gene)
gg <- unique(trmData_CanPass0$gene)

exprData_Genes <-
  exprData[gg, , drop = F]


exprData_Genes <-
  data.frame(
    cell_attrs,
    data.frame(
      t(exprData_Genes),
      check.rows = F,
      check.names = F
    ),
    check.rows = F,
    check.names = F
  )

exprData_GenesLong <-
  pivot_longer(
    exprData_Genes,
    cols = gg,
    names_to = "Genes",
    values_to = "logExpr"
  )


png(
  # paste0(figPath, "UMAP_Expr_Exh_CanPass.png"),
  paste0(figPath, "UMAP_Expr_Res_CanPass.png"),
  # height = 1000,
  # width = 1000
  height = 600,
  width = 700
)

exprData_GenesLong %>%
  group_by(Genes) %>% 
  arrange(logExpr) %>%
ggplot(., aes(x = UMAP_1, y = UMAP_2, color = logExpr)) +
  geom_point(alpha = 0.8, cex = 0.4) +
  facet_wrap(~ Genes) +
  scale_color_continuous(type = "viridis") +
theme_dark() +
      theme(
        axis.text = element_text(size = 13, face = "plain") ,
        axis.title = element_text(size = 15, face = "plain"),
        legend.spacing = unit(1.5, "mm"),
        legend.position = "top",
        legend.key.width = unit(0.9, "cm"),
        legend.title = element_text(size = 13, face = "italic"),
        legend.text = element_text(size = 13)
      )
 
dev.off()

```


# Check markers in stroma

#### Define Exh and Res subsets in each cell type
Define Exh and Res cells - for each of the NK, CD8 and CD4 cells, we define Exh and Res cells to be able to compare the expression of the genes in Exh/Res cells vs Fibroblasts.
```{r}
##------------ For NK cells
pNK <- cell_attrs %>%
  filter(Global_Cluster == "NK cell") %>% 
  ggplot(.,
         aes(x = NK_Res, y = NK_Exh, color = Sub_Cluster)) +
  geom_point(alpha = 0.8, size = 1) +
  scale_color_manual(values = nkCols) + 
  geom_vline(xintercept = 0.75) +
  geom_hline(yintercept = 0.75) +
  currentTheme +
  guides(color = guide_legend(nrow = 4,
                              override.aes = list(size = 3)))


cell_attrs$Cell_Groups[cell_attrs$Global_Cluster == "NK cell" &
                        cell_attrs$NK_Exh > 0.75 &
                        cell_attrs$NK_Res < 0.75 
                         ] <- "NK_Exh"

cell_attrs$Cell_Groups[cell_attrs$Global_Cluster == "NK cell" &
                        cell_attrs$NK_Exh < 0.75 &
                        cell_attrs$NK_Res > 0.75 
                         ] <- "NK_Res"


##------------ For CD8 T cells
pCD8 <- cell_attrs %>%
  filter(Global_Cluster == "CD8 T cell") %>% 
  ggplot(.,
         aes(x = CD8_Res, y = CD8_Exh, color = Sub_Cluster)) +
  geom_point(alpha = 0.8, size = 1) +
  scale_color_manual(values = cd8Cols) +
  geom_vline(xintercept = 0.7) +
  geom_hline(yintercept = 0.6) +
  geom_vline(xintercept = 0.8, lty = 2) +
  geom_hline(yintercept = 0.5, lty = 2) +
  currentTheme +
  guides(color = guide_legend(nrow = 4,
                              override.aes = list(size = 3)))


cell_attrs$Cell_Groups[cell_attrs$Global_Cluster == "CD8 T cell" &
                        cell_attrs$CD8_Exh > 0.6 &
                        cell_attrs$CD8_Res < 0.7 
                         ] <- "CD8_Exh"

cell_attrs$Cell_Groups[cell_attrs$Global_Cluster == "CD8 T cell" &
                        cell_attrs$CD8_Exh < 0.5 &
                        cell_attrs$CD8_Res > 0.8 
                         ] <- "CD8_Res"

##------------ For CD4 T cells
pCD4 <- cell_attrs %>%
  filter(Global_Cluster == "CD4 T cell") %>% 
  ggplot(.,
         aes(x = CD4_Res, y = CD4_Exh, color = Sub_Cluster)) +
  geom_point(alpha = 0.8, size = 1) +
  scale_color_manual(values = cd4Cols) +
  geom_vline(xintercept = 0.75) +
  geom_hline(yintercept = 0.65) +
  geom_vline(xintercept = 0.85, lty = 2) +
  geom_hline(yintercept = 0.5, lty = 2) +
  currentTheme +
  guides(color = guide_legend(nrow = 4,
                              override.aes = list(size = 3)))


cell_attrs$Cell_Groups[cell_attrs$Global_Cluster == "CD4 T cell" &
                        cell_attrs$CD4_Exh > 0.65 &
                        cell_attrs$CD4_Res < 0.75 
                         ] <- "CD4_Exh"

cell_attrs$Cell_Groups[cell_attrs$Global_Cluster == "CD4 T cell" &
                        cell_attrs$CD4_Exh < 0.5 &
                        cell_attrs$CD4_Res > 0.85 
                         ] <- "CD4_Res"



pdf(
  paste0(figPath, "Scatterplot_Scores_Res_Exh_ZhangSmartSeq.pdf"),
  height = 6,
  width = 6
)
pNK
pCD8
pCD4
dev.off()



# cell_attrs$Cell_Groups[grepl("Fibroblast", cell_attrs$Global_Cluster)] <- "Fibroblast"
cell_attrs$Cell_Groups[grepl("Myofib", cell_attrs$Sub_Cluster)] <- "Myofib"
cell_attrs$Cell_Groups[grepl("CAF-", cell_attrs$Sub_Cluster)] <- "CAF"


cell_attrs_sub <- cell_attrs[complete.cases(cell_attrs$Cell_Groups), ]



exprData <- as.matrix(GetAssayData(ss, slot = "data"))
exprData_sub <- exprData[, row.names(cell_attrs_sub)]





# gg <-  DEGs_CD8Exh$gene
# exprData_Genes <- exprData[gg, ]
# cell_attrsCD8 <- cd8[[]]
# 
# 
# Exh_Pct <-
#   rowQuantiles(exprData_Genes[, CD8_Exh_Cells], probs = 0.65)
# 
# Res_Pct <-
#   rowQuantiles(exprData_Genes[, CD8_Res_Cells], probs = 0.9)
# 
# Blood_Pct <-
#   rowQuantiles(exprData_Genes[, cell_attrsCD8$Tissue == "P"], probs = 0.9)
# 
# 
# pctData_cd8Exh <- data.frame(cbind(Exh_Pct,
#                                Res_Pct, 
#                                Blood_Pct
#                                ))
# 
# pctData_cd8Exh$gene <- rownames(pctData_cd8Exh)
# 
# pctData_cd8ExhPass <- pctData_cd8Exh %>% 
#   filter(Exh_Pct > Res_Pct & Exh_Pct> Blood_Pct) %>% 
#   data.frame()
# 
# pctData_cd8ExhPass <-
#   pctData_cd8ExhPass[order(pctData_cd8ExhPass$Exh_Pct, decreasing = T),]
# 
# DT::datatable(pctData_cd8ExhPass, filter = "top") ## 27 genes
# 
# 
# DEGs_CD8Exh$PctPass <- FALSE
# DEGs_CD8Exh$PctPass[DEGs_CD8Exh$gene %in% pctData_cd8ExhPass$gene] <- TRUE

```

#### Boxplot of Exh markers
```{r}

gg <- unique(exhData_CanPass0$gene)

exprData_Genes <-
  exprData_sub[gg, , drop = F]

exprData_Genes <-
  data.frame(
    cell_attrs_sub,
    data.frame(
      t(exprData_Genes),
      check.rows = F,
      check.names = F
    ),
    check.rows = F,
    check.names = F
  )


exprData_GenesLong <-
  pivot_longer(
    exprData_Genes,
    cols = gg,
    names_to = "Genes",
    values_to = "logExpr"
  )

exprData_GenesLong$Cell_Groups <-
  factor(
    exprData_GenesLong$Cell_Groups,
    levels = c(
      'CD4_Exh',
      'CD4_Res',
      'CD8_Exh',
      'CD8_Res',
      'NK_Exh',
      'NK_Res',
      # "Fibroblast"
      'Myofib',
      "CAF"
    )
  )



for(i in unique(exprData_GenesLong$Genes)){
  # x <- paste(trmData_CanPass0$Cell.Type[trmData_CanPass0$gene %in% i], collapse = " & ")
  x <- paste(exhData_CanPass0$Cell.Type[exhData_CanPass0$gene %in% i], collapse = " & ")
  exprData_GenesLong$Gene_Marker[exprData_GenesLong$Genes == i] <- paste0(i, "\n(", x, ")")
  
}


  legend_title_size <- 8 * textSize
  legend_text_size  <- 7 * textSize

pdf(
  # paste0(figPath, "Boxplot_Expr_ResMarkerCanPass_ExhResCells.pdf"),
  paste0(figPath, "Boxplot_Expr_ExhMarkerCanPass_ExhResCells_MyoCAF.pdf"),
    # height = 7.5,
    height = 15.5,
    width = 10)
ggplot(exprData_GenesLong, aes(Cell_Groups, logExpr, color = Cell_Groups)) +
  geom_boxplot(outlier.size = 0.2, show.legend = F) +
  facet_wrap(~ Gene_Marker, ncol = 7) + 
  scale_color_manual(values = brewer.pal(8, "Paired")) +
  # coord_flip() +
  theme_bw() +
    coord_flip() +
    ylab ("") +
    xlab("log(Expr)") +
    ggtitle("Expression of Exh_Bulk signture genes in Zhang et al single cell data") +
    theme(
      panel.grid.minor = element_blank(),
      axis.title = element_text(size = rel(textSize)),
      axis.text.x = element_text(angle = 0, size = rel(textSize)),
      # axis.text.y = element_blank(),
      axis.text.y = element_text(
        angle = 0,
        size = rel(textSize),
        face = "italic"
      ),
      axis.line = element_line(colour = "black"),
      axis.ticks = element_line(),
      legend.margin = margin(unit(0, "cm")),
      legend.title = element_text(face = "italic", size = legend_title_size),
      legend.text = element_text(size = legend_text_size),
      legend.key.size = unit(3, 'lines'),
      plot.title = element_text(
        face = "bold",
        size = rel(textSize),
        hjust = 0.5
      )
    ) +
    guides(fill = guide_legend(reverse = TRUE))
dev.off()

```

#### Boxplot of Res makers
```{r}

gg <- unique(trmData_CanPass0$gene)

exprData_Genes <-
  exprData_sub[gg, , drop = F]

exprData_Genes <-
  data.frame(
    cell_attrs_sub,
    data.frame(
      t(exprData_Genes),
      check.rows = F,
      check.names = F
    ),
    check.rows = F,
    check.names = F
  )


exprData_GenesLong <-
  pivot_longer(
    exprData_Genes,
    cols = gg,
    names_to = "Genes",
    values_to = "logExpr"
  )

exprData_GenesLong$Cell_Groups <-
  factor(
    exprData_GenesLong$Cell_Groups,
    levels = c(
      'CD4_Exh',
      'CD4_Res',
      'CD8_Exh',
      'CD8_Res',
      'NK_Exh',
      'NK_Res',
      # "Fibroblast"
      'Myofib',
      "CAF"
    )
  )



for(i in unique(exprData_GenesLong$Genes)){
  x <- paste(trmData_CanPass0$Cell.Type[trmData_CanPass0$gene %in% i], collapse = " & ")
  # x <- paste(exhData_CanPass0$Cell.Type[exhData_CanPass0$gene %in% i], collapse = " & ")
  exprData_GenesLong$Gene_Marker[exprData_GenesLong$Genes == i] <- paste0(i, "\n(", x, ")")
  
}


  legend_title_size <- 8 * textSize
  legend_text_size  <- 7 * textSize

pdf(
  paste0(figPath, "Boxplot_Expr_ResMarkerCanPass_ExhResCells_MyoCAF.pdf"),
  # paste0(figPath, "Boxplot_Expr_ExhMarkerCanPass_ExhResCells_MyoCAF.pdf"),
    height = 8.5,
    # height = 15.5,
    width = 10)
ggplot(exprData_GenesLong, aes(Cell_Groups, logExpr, color = Cell_Groups)) +
  geom_boxplot(outlier.size = 0.2, show.legend = F) +
  facet_wrap(~ Gene_Marker, ncol = 7) + 
  scale_color_manual(values = brewer.pal(8, "Paired")) +
  # coord_flip() +
  theme_bw() +
    coord_flip() +
    ylab ("") +
    xlab("log(Expr)") +
    ggtitle("Expression of Res_Bulk signture genes in Zhang et al single cell data") +
    theme(
      panel.grid.minor = element_blank(),
      axis.title = element_text(size = rel(textSize)),
      axis.text.x = element_text(angle = 0, size = rel(textSize)),
      # axis.text.y = element_blank(),
      axis.text.y = element_text(
        angle = 0,
        size = rel(textSize),
        face = "italic"
      ),
      axis.line = element_line(colour = "black"),
      axis.ticks = element_line(),
      legend.margin = margin(unit(0, "cm")),
      legend.title = element_text(face = "italic", size = legend_title_size),
      legend.text = element_text(size = legend_text_size),
      legend.key.size = unit(3, 'lines'),
      plot.title = element_text(
        face = "bold",
        size = rel(textSize),
        hjust = 0.5
      )
    ) +
    guides(fill = guide_legend(reverse = TRUE))
dev.off()

```

### Quantile comparison with stroma/fibroblast
Here we label genes that have higher median expression in stroma compared to each of teh corresponding cell types, and then we remove them from our Bulk signatures.
```{r}
exhData_CanPass0$Cell_Marker <- paste(exhData_CanPass0$Cell.Type,
                                      exhData_CanPass0$Marker, 
                                      sep = "_")


trmData_CanPass0$Cell_Marker <- paste(trmData_CanPass0$Cell.Type,
                                      trmData_CanPass0$Marker,
                                      sep = "_")

markersCanPass0 <- rbind(exhData_CanPass0, trmData_CanPass0)

gg <- unique(markersCanPass0$gene)


exprData_Genes <-
  exprData_sub[gg, , drop = F]

exprData_Genes <-
  data.frame(
    cell_attrs_sub,
    data.frame(
      t(exprData_Genes),
      check.rows = F,
      check.names = F
    ),
    check.rows = F,
    check.names = F
  )


exprData_GenesLong <-
  pivot_longer(
    exprData_Genes,
    cols = gg,
    names_to = "Genes",
    values_to = "logExpr"
  )

exprData_GenesLong$Cell_Groups[grepl("Myofib|CAF", 
                                     exprData_GenesLong$Cell_Groups)] <- "Fibroblast"

exprData_GenesLong$Cell_Groups <-
  factor(
    exprData_GenesLong$Cell_Groups,
    levels = c(
      'CD4_Exh',
      'CD4_Res',
      'CD8_Exh',
      'CD8_Res',
      'NK_Exh',
      'NK_Res',
      'Fibroblast'
    )
  )


for(i in unique(exprData_GenesLong$Genes)){
  x <- paste(markersCanPass0$Cell_Marker[markersCanPass0$gene %in% i], collapse = " & ")
  exprData_GenesLong$Cell_Marker[exprData_GenesLong$Genes == i] <- x
    # paste0(i, "\n(", x, ")")
}

## calculate the median expression of genes in each cell group
exprData_GenesLong_medExpr <- exprData_GenesLong %>%
  group_by(Cell_Groups, Genes) %>%
  mutate(medExpr_cellGroup = median(logExpr)) %>% 
  mutate(lowExpr_cellGroup = quantile(logExpr, probs = 0.75)) %>% 
  mutate(highExpr_cellGroup = quantile(logExpr, probs = 0.85)) %>% 
  data.frame()

exprData_GenesLong_medExpr_unique <- exprData_GenesLong_medExpr %>% 
  mutate(Cell_Gene = paste(Cell_Groups, Genes, sep = "\n")) %>% 
  filter(!duplicated(Cell_Gene)) %>% 
  data.frame()


##--------- comparing medians:

for(cc in c("NK_Res", "NK_Exh", "CD8_Res", "CD8_Exh", "CD4_Res", "CD4_Exh")){

  curCellData <- exprData_GenesLong_medExpr_unique %>% 
    ## subset to NK markers
    filter(grepl(cc, Cell_Marker)) %>% 
    ## subset to NK_Res or NKJ_Exh markers and only retain those cells 
    filter(grepl(cc, Cell_Gene) | grepl("Fibro", Cell_Gene)) %>% 
    data.frame()

  for(g in unique(curCellData$Genes)){
    curCellData_g <- curCellData[grepl(g, curCellData$Genes), ]
    
    # print(paste0(cc, "--", g, " -- Fibro: ", 
    #                      curCellData_g$medExpr_cellGroup[grepl("Fibroblast", curCellData_g$Cell_Gene)], 
    #                      " -- ", cc, ": ", 
    #                      curCellData_g$medExpr_cellGroup[grepl(cc, curCellData_g$Cell_Gene)]))
    
    
    if(
      curCellData_g$medExpr_cellGroup[grepl("Fibroblast", curCellData_g$Cell_Gene)] >
        curCellData_g$medExpr_cellGroup[grepl(cc, curCellData_g$Cell_Gene)]
    ){
            print(paste0(cc, "--", g,
                         " -- Fibro: ",
                         curCellData_g$medExpr_cellGroup[grepl("Fibroblast", curCellData_g$Cell_Gene)],
                         " -- ", cc, ": ",
                         curCellData_g$medExpr_cellGroup[grepl(cc, curCellData_g$Cell_Gene)]))
    }

  }
}

# 3/10 CD4_Res
# 2/37 CD4_Exh
# 1/17 CD8_Exh

# [1] "CD8_Exh--CSF1--TRUE"
# [1] "CD4_Res--PPP1R15A--TRUE"
# [1] "CD4_Res--NR4A3--TRUE"
# [1] "CD4_Res--ITGA1--TRUE"
# [1] "CD4_Exh--FNDC3B--TRUE"
# [1] "CD4_Exh--IL1R1--TRUE"

badGenes <- c(
  "CD8_Exh--CSF1",
  "CD4_Res--PPP1R15A",
  "CD4_Res--NR4A3",
  "CD4_Res--ITGA1",
  "CD4_Exh--FNDC3B",
  "CD4_Exh--IL1R1"
)


markersCanPass0$Marker_Genes <-
  paste(markersCanPass0$Cell_Marker, markersCanPass0$gene, sep = "--")

markersCanPass0$HighInStroma <- FALSE
markersCanPass0$HighInStroma[markersCanPass0$Marker_Genes %in% badGenes] <- TRUE

write.table(markersCanPass0, paste0(outPath, "Markers_ResExh_Bulk_Stroma.txt"), 
            row.names = F, sep = "\t")


# markersCanPass0 <- read.table(paste0(outPath, "Markers_ResExh_Bulk_Stroma.txt"),
#                               header = T, sep = "\t")
```



### Correlation between Res/Exh and Trm_TGFb scores
Here we reproduce Supp Figure 7.
```{r, fig.height = 4, fig.width = 6.5}
a <-
  cell_attrs[,
    c(
    "NK_Exh",
    "NK_Res",
    "CD4_Exh",
    "CD4_Res",
    "CD8_Exh",
    "CD8_Res",
    "TRM_TGFb_Unstim_Up",
    "Sub_Cluster",
    "Global_Cluster",
    "Tissue"
  )]

aLong <-
  pivot_longer(
    a,
    cols = c("NK_Exh", "NK_Res", "CD4_Exh", "CD4_Res", "CD8_Exh", "CD8_Res"),
    values_to = "Score",
    names_to = "Signature"
  ) %>% data.frame()

aLong$Global_Cluster[aLong$Global_Cluster == "CD4 T cell"] <- "CD4"
aLong$Global_Cluster[aLong$Global_Cluster == "CD8 T cell"] <- "CD8"
aLong$Global_Cluster[aLong$Global_Cluster == "NK cell"] <- "NK"

# pdf(paste0(figPath, "Scatterplot_ResExhScores_TrmTGFbScore_density.pdf"), height = 4, width = 6.5)
for(i in unique(aLong$Global_Cluster)){
  currentData <- aLong %>% 
    filter(aLong$Global_Cluster  %in% i & grepl(i, aLong$Signature))
  
  print(
    ggplot(currentData, aes(Score, TRM_TGFb_Unstim_Up)) +
      ggpointdensity::geom_pointdensity() + 
      scale_color_viridis_c() +
      facet_wrap( ~ Signature) +
      DEGreport::geom_cor(method = "pearson") +
      currentTheme +
      theme(legend.key.width = unit(2, "cm"))
  )
}
# dev.off()

```

# Compare Exh and Res markers
## Compare Exh markers across cell types
We compare the Exh signature genes in NK, CD8 and CD4 cells using a heatmap; we also annotate which of these genes also pass the bulk cancer threshold. This generates the heatmap in Figure 3 (panel A, left heatmap).
```{r, fig.height = 18, fig.width = 3.5}

exhData <- data.frame(gene = unique(c(
  cd8Sigs$gene[cd8Sigs$Marker == "Exh"],
  cd4Sigs$gene[cd4Sigs$Marker == "Exh"],
  nkSigs$gene[nkSigs$Marker == "Exh"]
  )))

exhData$NK <- 0
exhData$NK[exhData$gene %in% nkSigs$gene[nkSigs$Marker == "Exh"]] <- 1
exhData$CD8 <- 0
exhData$CD8[exhData$gene %in% cd8Sigs$gene[cd8Sigs$Marker == "Exh"]] <- 1
exhData$CD4 <- 0
exhData$CD4[exhData$gene %in% cd4Sigs$gene[cd4Sigs$Marker == "Exh"]] <- 1


rownames(exhData) <- exhData$gene
exhData <- exhData[, -1]

exhData$Counts <- rowSums(exhData)
exhData <- exhData[order(exhData$Counts, decreasing = T), ]

exhData$Bulk <- FALSE
exhData$Bulk[rownames(exhData) %in% exhData_CanPass0$gene] <- TRUE

passCol <- c("gray80", "black")
names(passCol) <- c(FALSE, TRUE)

library(grid)

geneAnnot <- ComplexHeatmap::rowAnnotation(
  df = exhData[, "Bulk", drop = F],
  name = "Pass Cancer threshold",
  col = list(Bulk = passCol),
  annotation_legend_param = list(Bulk =
                                   list(
                                     title_gp = gpar(fontsize = 18),
                                     labels_gp = gpar(fontsize = 16),
                                     grid_height = unit(1, "cm")))
                                   ,
  # show_legend = F
  show_legend = T
)


colors = structure(c("Purple4", "darkslategray3"), names = c("1", "0"))

# pdf(
#   paste0(figPath, "Heatmap_ExhMarkers_TNK_Bulk_rmLegend.pdf"),
#   height = 18.5,
#   width = 3.3
#   # width = 4
# )
ComplexHeatmap::Heatmap(
  exhData[, 1:3],
  right_annotation = geneAnnot,
  col = colors,
  name = "Genes",
  heatmap_legend_param = list(at = c(0, 1),
                              labels = c("Absent", "Present"),
                              title_gp = gpar(fontsize = 18),
                              labels_gp = gpar(fontsize = 16),
                              grid_height = unit(1, "cm")
                             ),
  show_heatmap_legend = F,
  column_title = "Exhaustion\nmarkers",
  column_title_gp = gpar(fontsize = 20)
)
# pheatmap::pheatmap(as.matrix(exhData[, 1:3]))
# dev.off()


```


## Compare Res markers across cell types
We compare the Res signature genes in NK, CD8 and CD4 cells using a heatmap; we also annotate which of these genes also pass the bulk cancer threshold. This generates the heatmap in Figure 3 (panel A, right heatmap).
```{r, fig.height = 18, fig.width = 3.5}
trmData <- data.frame(gene = unique(c(
  cd8Sigs$gene[cd8Sigs$Marker == "Res"],
  cd4Sigs$gene[cd4Sigs$Marker == "Res"],
  nkSigs$gene[nkSigs$Marker == "Res"]
  )))

trmData$NK <- 0
trmData$NK[trmData$gene %in% nkSigs$gene[nkSigs$Marker == "Res"]] <- 1
trmData$CD8 <- 0
trmData$CD8[trmData$gene %in% cd8Sigs$gene[cd8Sigs$Marker == "Res"]] <- 1
trmData$CD4 <- 0
trmData$CD4[trmData$gene %in% cd4Sigs$gene[cd4Sigs$Marker == "Res"]] <- 1
rownames(trmData) <- trmData$gene
trmData <- trmData[, -1]

trmData$Counts <- rowSums(trmData)
trmData <- trmData[order(trmData$Counts, decreasing = T), ]


trmData$Bulk <- FALSE
trmData$Bulk[rownames(trmData) %in% trmData_CanPass0$gene] <- TRUE

passCol <- c("gray80", "black")
names(passCol) <- c(FALSE, TRUE)

geneAnnot <- ComplexHeatmap::rowAnnotation(
  df = trmData[, "Bulk", drop = F],
  name = "Pass Cancer threshold",
  col = list(Bulk = passCol),
  annotation_legend_param = list(Bulk =
                                   list(
                                     title_gp = gpar(fontsize = 18),
                                     labels_gp = gpar(fontsize = 16),
                                     grid_height = unit(1, "cm")))
                                   ,
  show_legend = T
)


colors = structure(c("Purple4", "darkslategray3"), names = c("1", "0"))

# pdf(paste0(figPath, "Heatmap_TrmMarkers_TNK_Bulk.pdf"), height = 18.5, width = 4)
ComplexHeatmap::Heatmap(
  trmData[, 1:3],
  right_annotation = geneAnnot,
  col = colors,
  name = "Genes",
  heatmap_legend_param = list(at = c(0, 1),
                              labels = c("Absent", "Present"),
                              title_gp = gpar(fontsize = 18),
                              labels_gp = gpar(fontsize = 16),
                               grid_height = unit(1, "cm")),
  column_title = "Residency\nmarkers",
  column_title_gp = gpar(fontsize = 20)
)
# dev.off()


```

# Expression of markers in cancer cells
## CCLE Heatmap for Exh and Res
Visualise the expression of the marker genes in the CCLE CRC data.
```{r, fig.height = 18, fig.width = 4.5, cache = T}
# selectedGenes <- c(trmData$Gene, exhData$Gene)
selectedGenes <- unique(c(rownames(exhData), rownames(trmData)))

dge <- readRDS(paste0(ccleLcmPath, "DGEList_CCLE_panCancer.RDS"))

library(edgeR)
  
kp <- rowSums(cpm(dge) > 1) >= 5 |
  dge$genes$Symbol %in% selectedGenes
# summary(kp)

dgeFilt <- dge[kp, ]
dgeFiltNorm <- calcNormFactors(dgeFilt)
logRPKM <- rpkm(dgeFiltNorm, log = T, gene.length = dgeFiltNorm$genes$gene_length)

gg <- selectedGenes[selectedGenes %in% dgeFiltNorm$genes$Symbol]

logRPKM_CRC <- logRPKM[, dgeFiltNorm$samples$type_refined == "colorectal"]
logRPKM_CRC <- logRPKM_CRC [, ! is.na(colnames(logRPKM_CRC))]
logRPKM_CRC_scaled <- scale(logRPKM_CRC)

# brbg <- rev(RColorBrewer::brewer.pal(11, "PRGn"))
brbg_hcl <- colorspace::diverging_hcl(11,
  h = c(180, 50), c = 80, l = c(20, 95), power = c(0.7, 1.3))

##---- for annot
dAnn <- data.frame(Genes = gg)
dAnn$Marker[dAnn$Genes %in% rownames(exhData)] <- "Exh"
dAnn$Marker[dAnn$Genes %in% rownames(trmData)] <- "Res"

dAnn$Bulk <- FALSE
dAnn$Bulk[dAnn$Genes %in% trmData_CanPass0$gene |
          dAnn$Genes %in% exhData_CanPass0$gene  ] <- TRUE

passCol <- c("gray80", "black")
names(passCol) <- c(FALSE, TRUE)

markerCol <- c("orange", "blue")
names(markerCol) <- c("Res", "Exh")

geneAnnot <- ComplexHeatmap::rowAnnotation(
  df = dAnn[, c("Marker", "Bulk") , drop = F],
  col = list(Marker = markerCol,
             Bulk = passCol), 
  show_annotation_name = FALSE,
  annotation_legend_param = list(
    Bulk =
      list(
        title = "\nBulk",
        title_gp = gpar(fontsize = 18),
        labels_gp = gpar(fontsize = 16),
        grid_height = unit(1, "cm")
      ),
    Marker =
      list(
        title = "\nMarker",
        title_gp = gpar(fontsize = 18),
        labels_gp = gpar(fontsize = 16),
        grid_height = unit(1, "cm")
      )
  )
  ,
  show_legend = F
)


# pdf(
#   paste0(
#     figPath,
#     "Heatmap_CCLE_CRC_ResExh_Markers_NKT_scaled_annot_rmLegend.pdf"
#   ),
#   height = 18.5,
#   width = 4.2
# )

ComplexHeatmap::Heatmap(
  logRPKM_CRC_scaled[gg, ],
  right_annotation = geneAnnot,
  col = brbg_hcl,
  name = "Scaled\nlogRPKM\n", 
  heatmap_legend_param = list(title_gp = gpar(fontsize = 18),
                              labels_gp = gpar(fontsize = 16),
                               grid_height = unit(1, "cm")),
  column_title = "Exh and Res markers\nin CCLE CRC data\n (N = 56)",
  column_title_gp = gpar(fontsize = 20),
                        show_column_names = F,
                        show_row_names = F, 
  # show_heatmap_legend = F
  show_heatmap_legend = T
  )
  
# dev.off()

```

## LCM Heatmap for Exh and Res
Visualise the expression of the marker genes in the LCM CRC microarray data.
```{r, fig.height = 18, fig.width = 4.5, cache = T}
ll <- readRDS(paste0(ccleLcmPath, "ColoRectal_GeneExpression_LCM_MicroArray_GSE21510_AvergedProbes_Filtered.rds"))

gg <- selectedGenes[selectedGenes %in% rowData(ll)$Gene.Symbol]

l <- ll[rowData(ll)$Gene.Symbol %in% gg , ll$`tissue:ch1` == "cancer, LCM" ]


lExpr <- assay(l)
row.names(lExpr) <- rowData(l)$Gene.Symbol

lExprScaled <- scale(lExpr)
brbg_hcl <- colorspace::diverging_hcl(11,
  h = c(180, 50), c = 80, l = c(20, 95), power = c(0.7, 1.3))

dAnn <- data.frame(Genes = gg)
dAnn$Marker[dAnn$Genes %in% rownames(exhData)] <- "Exh"
dAnn$Marker[dAnn$Genes %in% rownames(trmData)] <- "Res"

dAnn$Bulk <- FALSE
dAnn$Bulk[dAnn$Genes %in% trmData_CanPass0$gene |
          dAnn$Genes %in% exhData_CanPass0$gene  ] <- TRUE

passCol <- c("gray80", "black")
names(passCol) <- c(FALSE, TRUE)

markerCol <- c("orange", "blue")
names(markerCol) <- c("Res", "Exh")

geneAnnot <- ComplexHeatmap::rowAnnotation(
  df = dAnn[, c("Marker", "Bulk") , drop = F],
  col = list(Marker = markerCol,
             Bulk = passCol),
  show_annotation_name = FALSE,
  annotation_legend_param = list(
    Bulk =
      list(
        title = "\nBulk",
        title_gp = gpar(fontsize = 18),
        labels_gp = gpar(fontsize = 16),
        grid_height = unit(1, "cm")
      ),
    Marker =
      list(
        title = "\nMarker",
        title_gp = gpar(fontsize = 18),
        labels_gp = gpar(fontsize = 16),
        grid_height = unit(1, "cm")
      )
  )
  ,
  show_legend = T
)


# pdf(
#   paste0(
#     figPath,
#     "Heatmap_GEO_LCM_CRC_ResExh_Markers_NKT_scaled_annot.pdf"
#   ),
#   height = 18.5,
#   width = 5
# )

ComplexHeatmap::Heatmap(
  lExprScaled[gg, ],
  right_annotation = geneAnnot,
  col = brbg_hcl,
  name = "Scaled\nlogExpr\n", 
  heatmap_legend_param = list(title_gp = gpar(fontsize = 18),
                              labels_gp = gpar(fontsize = 16),
                               grid_height = unit(1, "cm")),
  column_title = "Exh and Res markers\nin LCM CRC data\n (N = 104)",
  column_title_gp = gpar(fontsize = 20),
                        show_column_names = F,
                        show_row_names = F)
  
# dev.off()

```

# DE analysis for Prolif vs non-prolif Exh cells
## Scatterplot of Exh vs Prolif
```{r}
# 
# pdf(
#   paste0(figPath, "ScatterPlot_Exh_Prolif.pdf"),
#   height = 7,
#   width = 6.2
# )
# cell_attrs %>%
#   arrange(Proliferation_imsig) %>%
#   ggplot(., aes(All_Trm, All_Exh, color = Proliferation_imsig)) + geom_point(alpha = 0.8) +
#   scale_color_viridis_c() +
#   currentTheme +
#     guides(color = guide_legend(
#     nrow = 7,
#     override.aes = list(size = 3)))
# 
# ggplot(cell_attrs, aes(Proliferation_imsig, All_Exh, color = Sub_Cluster)) + 
#   geom_point(alpha = 0.7) +
#   scale_color_manual(values = cellCols) +
#   currentTheme +
#     guides(color = guide_legend(
#     nrow = 7,
#     override.aes = list(size = 3)))
# 
# cell_attrs %>% 
#   filter(grepl("CD8-", Sub_Cluster)) %>% 
# ggplot(., aes(Proliferation_imsig, CD8_Exh, color = Sub_Cluster)) + geom_point() +
#   scale_color_manual(values = cd8Cols) +
#   currentTheme +
#     guides(color = guide_legend(
#     nrow = 7,
#     override.aes = list(size = 3)))
# 
# cell_attrs %>% 
#   filter(grepl("CD4-", Sub_Cluster)) %>% 
# ggplot(., aes(Proliferation_imsig, CD4_Exh, color = Sub_Cluster)) + geom_point() +
#   scale_color_manual(values = cd4Cols) +
#   currentTheme +
#     guides(color = guide_legend(
#     nrow = 7,
#     override.aes = list(size = 3)))
# 
# cell_attrs %>% 
#   filter(grepl("NK-", Sub_Cluster)) %>% 
# ggplot(., aes(Proliferation_imsig, NK_Exh, color = Sub_Cluster)) + geom_point() +
#   scale_color_manual(values = nkCols) +
#   currentTheme +
#     guides(color = guide_legend(
#     nrow = 7,
#     override.aes = list(size = 3)))
# 
# dev.off()

```

Supp Figure 4, top panel. 
```{r, fig.height = 4, fig.width = 4.2}

# pdf(
#   paste0(figPath, "ScatterPlot_Exh_Prolif_noCols.pdf"),
#   height = 4.1,
#   width = 4.5
# )

# cell_attrs %>%
#   arrange(Proliferation_imsig) %>%
#   ggplot(., aes(All_Trm, All_Exh, color = Proliferation_imsig)) + geom_point(alpha = 0.8) +
#   scale_color_viridis_c() +
#   currentTheme 
# 
# ggplot(cell_attrs, 
#        aes(Proliferation_imsig, All_Exh)) + 
#   geom_point(alpha = 0.7, color = "gray50") +
#   geom_vline(xintercept = 0.3, lwd = 1, lty = 2) +
#   geom_vline(xintercept = 0.4, lwd = 1) +
#   geom_hline(yintercept = 0.6, lwd = 1, lty = 2) +
#   currentTheme 

cell_attrs %>% 
  filter(grepl("CD8-", Sub_Cluster)) %>% 
ggplot(., aes(Proliferation, CD8_Exh)) + 
  geom_point(alpha = 0.8, color = "gray50") +
  geom_vline(xintercept = 0.3, lwd = 1, lty = 2) +
  geom_vline(xintercept = 0.4, lwd = 1) +
  geom_hline(yintercept = 0.6, lwd = 1, lty = 2) +
  currentTheme 

cell_attrs %>% 
  filter(grepl("CD4-", Sub_Cluster)) %>% 
ggplot(., aes(Proliferation, CD4_Exh)) + 
  geom_point(alpha = 0.8, color = "gray50") +
  geom_vline(xintercept = 0.3, lwd = 1, lty = 2) +
  geom_vline(xintercept = 0.4, lwd = 1) +
  geom_hline(yintercept = 0.6, lwd = 1, lty = 2) +
  currentTheme 

cell_attrs %>% 
  filter(grepl("NK-", Sub_Cluster)) %>% 
ggplot(., aes(Proliferation, NK_Exh)) + 
  geom_point(alpha = 0.8, color = "gray50") +
    geom_vline(xintercept = 0.3, lwd = 1, lty = 2) +
    geom_vline(xintercept = 0.4, lwd = 1) +
    geom_hline(yintercept = 0.75, lwd = 1, lty = 2) +
  currentTheme 

# dev.off()

```
Exhausted immune cells have two sub-populations of proliferative and non-proliferative cells. In order to understand the heterogeneity across the exhausted population of T and NK cells, we stratified samples based on their exhaustion and proliferation scores, and obtained markers that were highly expressed in proliferative exhausted cells compared to non-proliferative exhausted cells (Suppl Table S3). 
```{r}
cell_attrs$GroupDE <- NA
cell_attrs$GroupDE[cell_attrs$Proliferation > 0.4] <- "Prolif"

cell_attrs$GroupDE[
  grepl("NK", cell_attrs$Sub_Cluster) &
  cell_attrs$NK_Exh > 0.75 &
  cell_attrs$Proliferation < 0.3 
                     ] <- "NK_Exh_NonProlif"

cell_attrs$GroupDE[
  grepl("CD8", cell_attrs$Sub_Cluster) &
  cell_attrs$CD8_Exh > 0.6 &
  cell_attrs$Proliferation < 0.3 
                     ] <- "CD8_Exh_NonProlif"

cell_attrs$GroupDE[
  grepl("CD4", cell_attrs$Sub_Cluster) &
  cell_attrs$CD4_Exh > 0.6 &
  cell_attrs$Proliferation < 0.3 
                     ] <- "CD4_Exh_NonProlif"


ss@meta.data <- cell_attrs
```

```{r}
NKTissue <- ss[,
                grepl("NK", ss$Sub_Cluster) &
                  complete.cases(ss$GroupDE) &
                  !ss$Tissue == "P" ]

CD8Tissue <- ss[,
                grepl("CD8", ss$Sub_Cluster) &
                  complete.cases(ss$GroupDE) &
                  !ss$Tissue == "P" ]
CD4Tissue <- ss[,
                grepl("CD4", ss$Sub_Cluster) &
                  complete.cases(ss$GroupDE) &
                  !ss$Tissue == "P" ]

CD8Tissue <- SetIdent(CD8Tissue, value = "GroupDE")
CD4Tissue <- SetIdent(CD4Tissue, value = "GroupDE")
NKTissue <- SetIdent(NKTissue, value = "GroupDE")
```

### CD8 Exh-Prolif markers
```{r}
##------- Find markers for CD8-Exh-Prolif vs CD8-Exh-nonProlif
markers_CD8Prolif <-
  FindMarkers(
    CD8Tissue,
    ident.1 = "Prolif",
    ident.2 = "CD8_Exh_NonProlif",
    only.pos = TRUE,
    min.pct = 0.5,
    logfc.threshold = 0.5
  )

markers_CD8Prolif$gene <- rownames(markers_CD8Prolif)
markers_CD8Prolif$Marker <- "CD8_Exh_Prolif"

## 248
DEGs_CD8Prolif <- markers_CD8Prolif[markers_CD8Prolif$avg_logFC > 0.5 & markers_CD8Prolif$p_val_adj < 0.05, ]

## Add GPCRs:
DEGs_CD8Prolif$IsGPCR <- FALSE
DEGs_CD8Prolif$IsGPCR[DEGs_CD8Prolif$gene %in% gpr] <- TRUE
## Add TFs:
DEGs_CD8Prolif$IsTF <- FALSE
DEGs_CD8Prolif$IsTF[DEGs_CD8Prolif$gene %in% TFs$Gene] <- TRUE

DT::datatable(DEGs_CD8Prolif, filter = "top")
```


### CD4 Exh-Prolif markers
```{r}
##------- Find markers for CD4-Exh-Prolif vs CD4-Exh-nonProlif
markers_CD4Prolif <-
  FindMarkers(
    CD4Tissue,
    ident.1 = "Prolif",
    ident.2 = "CD4_Exh_NonProlif",
    only.pos = TRUE,
    min.pct = 0.5,
    logfc.threshold = 0.5
  )

markers_CD4Prolif$gene <- rownames(markers_CD4Prolif)
markers_CD4Prolif$Marker <- "CD4_Exh_Prolif"

## 279
DEGs_CD4Prolif <- markers_CD4Prolif[markers_CD4Prolif$avg_logFC > 0.5 & markers_CD4Prolif$p_val_adj < 0.05, ]

## Add GPCRs:
DEGs_CD4Prolif$IsGPCR <- FALSE
DEGs_CD4Prolif$IsGPCR[DEGs_CD4Prolif$gene %in% gpr] <- TRUE
## Add TFs:
DEGs_CD4Prolif$IsTF <- FALSE
DEGs_CD4Prolif$IsTF[DEGs_CD4Prolif$gene %in% TFs$Gene] <- TRUE

DT::datatable(DEGs_CD4Prolif, filter = "top")
```


### NK Exh-Prolif markers
```{r}
##------- Find markers for NK-Exh-Prolif vs NK-Exh-nonProlif
markers_NKProlif <-
  FindMarkers(
    NKTissue,
    ident.1 = "Prolif",
    ident.2 = "NK_Exh_NonProlif",
    only.pos = TRUE,
    min.pct = 0.5,
    logfc.threshold = 0.5
  )

markers_NKProlif$gene <- rownames(markers_NKProlif)
markers_NKProlif$Marker <- "NK_Exh_Prolif"

## 198
DEGs_NKProlif <- markers_NKProlif[markers_NKProlif$avg_logFC > 0.5 & markers_NKProlif$p_val_adj < 0.05, ]

## Add GPCRs:
DEGs_NKProlif$IsGPCR <- FALSE
DEGs_NKProlif$IsGPCR[DEGs_NKProlif$gene %in% gpr] <- TRUE
## Add TFs:
DEGs_NKProlif$IsTF <- FALSE
DEGs_NKProlif$IsTF[DEGs_NKProlif$gene %in% TFs$Gene] <- TRUE

DT::datatable(DEGs_NKProlif, filter = "top")
```

138 genes are common acoss the three Exh-proliferative signatures. We export Supp Table 3.
```{r}
DEGs <- rbind(
  DEGs_CD8Prolif,
  DEGs_CD4Prolif,
  DEGs_NKProlif)

# write.table(
#   DEGs,
#   paste0(outPath, "DEGs_Stats_ProlifExh_NonProlif.txt"),
#   row.names = F,
#   sep = "\t"
# )

DEGsWide <- data.frame(Genes = unique(DEGs$gene))
DEGsWide$CD8_Exh_Prolif <- FALSE
DEGsWide$CD8_Exh_Prolif[DEGsWide$Genes  %in% DEGs_CD8Prolif$gene] <- TRUE
DEGsWide$CD4_Exh_Prolif <- FALSE
DEGsWide$CD4_Exh_Prolif[DEGsWide$Genes  %in% DEGs_CD4Prolif$gene] <- TRUE
DEGsWide$NK_Exh_Prolif <- FALSE
DEGsWide$NK_Exh_Prolif[DEGsWide$Genes  %in% DEGs_NKProlif$gene] <- TRUE

DEGsWide$Counts <- rowSums(DEGsWide[, 2:4])


## Add GPCRs:
DEGsWide$IsGPCR <- FALSE
DEGsWide$IsGPCR[DEGsWide$Genes %in% gpr] <- TRUE
## Add TFs:
DEGsWide$IsTF <- FALSE
DEGsWide$IsTF[DEGsWide$Genes %in% TFs$Gene] <- TRUE
  

DEGsWide <- DEGsWide[order(DEGsWide$Counts, decreasing = T), ]
# DEGsWide <- DEGs %>% 
#   dplyr::select(gene, Marker, IsGPCR, IsTF) %>% 
#   pivot_wider(., names_from = "Marker")

# write.table(
#   DEGsWide,
#   paste0(outPath, "DEGs_ProlifExh_NonProlif.txt"),
#   row.names = F,
#   sep = "\t"
# )

# DEGsWide <- read.table(paste0(outPath, "DEGs_ProlifExh_NonProlif.txt"), header = T, sep = "\t")
## 138 common genes

DT::datatable(DEGsWide, filter = "top")
```



## Heatmaps of DEGs
Here we visualise the top DEGs between prolif Exh and non-prolif Exh cells for each cell type. These reproduce the Suppl Figure 4, bottom panel.
```{r}
exprData <- as.matrix(GetAssayData(ss, slot = "data"))
exprDataScale <- as.matrix(GetAssayData(ss, slot = "scale.data"))
```

### Prolif vs non-prolif Exh CD8 cells
```{r, fig.height=8, fig.width = 4.2}
exprDataScale_CD8 <- as.matrix(GetAssayData(CD8Tissue, slot = "scale.data"))
exprData_CD8 <- as.matrix(GetAssayData(CD8Tissue, slot = "data"))
DEGs_CD8Prolif <- DEGs_CD8Prolif[order(DEGs_CD8Prolif$p_val_adj), ]

gg <- head(DEGs_CD8Prolif$gene, 40)

groupCol <- c("black",  "gray70")
names(groupCol) <- c("Prolif", 
                     "CD8_Exh_NonProlif"
                     )

annHm <- ComplexHeatmap::HeatmapAnnotation(
  Group = CD8Tissue$GroupDE,
  col = list(Group = groupCol))

mainHm <- ComplexHeatmap::Heatmap(
 exprData_CD8[gg, , drop = F],
  show_row_names = T, 
  show_column_names = F, 
  cluster_columns = T, 
  col = viridis::viridis(100),
  show_row_dend = FALSE,
  show_column_dend = FALSE,
  top_annotation = annHm, 
 name = "logExpr",
 column_title  = "Top proliferative markers in\nexhausted CD8 cells", 
 heatmap_legend_param = list(direction = "horizontal"))


# png(paste0(figPath, "HeatmapComplex_CD8_Prolif40.png"), width = 300, height = 580)
ComplexHeatmap::draw(
  mainHm,
  annotation_legend_side = "bottom",
  merge_legend = TRUE,
  heatmap_legend_side = "bottom"
)
# dev.off()
```

### Prolif vs non-prolif Exh CD4 cells
```{r, fig.height=8, fig.width = 4.2}
exprDataScale_CD4 <- as.matrix(GetAssayData(CD4Tissue, slot = "scale.data"))
exprData_CD4 <- as.matrix(GetAssayData(CD4Tissue, slot = "data"))
DEGs_CD4Prolif <- DEGs_CD4Prolif[order(DEGs_CD4Prolif$p_val_adj), ]


gg <- head(DEGs_CD4Prolif$gene, 40)

groupCol <- c("black",  "gray70")
names(groupCol) <- c("Prolif", 
                     "CD4_Exh_NonProlif"
                     )

annHm <- ComplexHeatmap::HeatmapAnnotation(
  Group = CD4Tissue$GroupDE,
  col = list(Group = groupCol))

mainHm <- ComplexHeatmap::Heatmap(
 exprData_CD4[gg, , drop = F],
  show_row_names = T, 
  show_column_names = F, 
  cluster_columns = T, 
  col = viridis::viridis(100),
  show_row_dend = FALSE,
  show_column_dend = FALSE,
  top_annotation = annHm, 
 name = "logExpr",
 column_title  = "Top proliferative markers in\nexhausted CD4 cells", 
 heatmap_legend_param = list(direction = "horizontal"))


# png(paste0(figPath, "HeatmapComplex_CD4_Prolif40.png"), width = 300, height = 580)
ComplexHeatmap::draw(
  mainHm,
  annotation_legend_side = "bottom",
  merge_legend = TRUE,
  heatmap_legend_side = "bottom"
)
# dev.off()



```

### Prolif vs non-prolif Exh NK cells
```{r, fig.height=8, fig.width = 4.2}
exprDataScale_NK <- as.matrix(GetAssayData(NKTissue, slot = "scale.data"))
exprData_NK <- as.matrix(GetAssayData(NKTissue, slot = "data"))
DEGs_NKProlif <- DEGs_NKProlif[order(DEGs_NKProlif$p_val_adj), ]


gg <- head(DEGs_NKProlif$gene, 40)

groupCol <- c("black",  "gray70")
names(groupCol) <- c("Prolif", 
                     "NK_Exh_NonProlif"
                     )

annHm <- ComplexHeatmap::HeatmapAnnotation(
  Group = NKTissue$GroupDE,
  col = list(Group = groupCol))

mainHm <- ComplexHeatmap::Heatmap(
 exprData_NK[gg, , drop = F],
  show_row_names = T, 
  show_column_names = F, 
  cluster_columns = T, 
  col = viridis::viridis(100),
  show_row_dend = FALSE,
  show_column_dend = FALSE,
  top_annotation = annHm, 
 name = "logExpr",
 column_title  = "Top proliferative markers in\nexhausted NK cells", 
 heatmap_legend_param = list(direction = "horizontal"))


# png(paste0(figPath, "HeatmapComplex_NK_Prolif40.png"), width = 300, height = 580)
ComplexHeatmap::draw(
  mainHm,
  annotation_legend_side = "bottom",
  merge_legend = TRUE,
  heatmap_legend_side = "bottom"
)
# dev.off()



```

# Session information
Here are the list of tools and packages (along with their versions) used in this document. 
```{r}
sessionInfo()
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 598px;"></div>


