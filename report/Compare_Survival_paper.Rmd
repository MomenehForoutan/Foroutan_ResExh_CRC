

# Set up and overview
In this document, we compare teh results of the survival analyses in teh TCGA to those from the Marisa et al data.
```{r}
mainDir <- getwd()
outPath <- "../output/CompareSurvival/"
figPath <- "../figure/CompareSurvival/"
dataPath <- "../data/"
scriptPath <- "../script/"

marPath <- "../output/Marisa/"
tcgaPath <- "../output/TCGA/"


ifelse(!dir.exists(file.path(mainDir, outPath)), dir.create(file.path(mainDir, outPath)), FALSE)
ifelse(!dir.exists(file.path(mainDir, figPath)), dir.create(file.path(mainDir, figPath)), FALSE)
ifelse(!dir.exists(file.path(mainDir, dataPath)), dir.create(file.path(mainDir, dataPath)), FALSE)
ifelse(!dir.exists(file.path(mainDir, scriptPath)), dir.create(file.path(mainDir, scriptPath)), FALSE)

# library(ggplot2)
library(tidyverse)
library(RColorBrewer)
library(ggbeeswarm)
library(SingleCellExperiment)
library(Seurat)
library(hgu133a.db)

options(digits = 3)

equal_breaks <- function(n = nBreak, s = scalingFactor, ...){
  function(x){
    # rescaling
    d <- s * diff(range(x)) / (1+2*s)
    round( seq(min(x)+d, max(x)-d, length=n), 2)
  }
}

nBreak = 3
scalingFactor = 0.05

textSize <- 1.3

currentTheme <- theme_bw() +
  theme(
    # panel.background = element_blank()
    axis.title = element_text(size = rel(textSize)),
    axis.text = element_text(angle = 0, size = rel(textSize)),
    # strip.background = element_rect(colour = "#f0f0f0", fill = "#f0f0f0"),
    strip.text = element_text(size = rel(textSize)),
    axis.line = element_line(colour = "black", size = 0.5),
    legend.position = 'top',
    legend.title = element_text(size = rel(textSize), face = "italic"),
    legend.text = element_text(size = rel(textSize)),
    legend.key.size = unit(1, 'lines'),
    ## increase the line space
    plot.title = element_text(
      face = "bold",
      size = rel(textSize),
      hjust = 0.5
    )
  )

cols <-  c(
  brewer.pal(8, "Dark2")[-5],
  brewer.pal(10, "Paired"),
  brewer.pal(12, "Set3"),
  brewer.pal(9, "Blues")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Oranges")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Greens")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Purples")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Reds")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "Greys")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "BuGn")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "PuRd")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "BuPu")[c(8, 3, 7, 4, 6, 9, 5)],
  brewer.pal(9, "YlGn")[c(8, 3, 7, 4, 6, 9, 5)])


# source(paste0(scriptPath, "visReduction_function.R"))
source("../script/coxph_analysis.R")
source("../script/survival_plot.R")
```


# Compare OS 
## Score pairs
Three common significant score pairs are below.
```{r}
os_scorePairs_mar <- read.csv(paste0(marPath, "Marisa_Cox_OS_2ScorePairs_significant2.csv"), 
         stringsAsFactors = F, 
         check.names = F)

os_scorePairs_tcga <- read.csv(paste0(tcgaPath, "TCGA_COAD_RUV_Cox_OS_2ScorePairs_significant.csv"), 
         stringsAsFactors = F, 
         check.names = F)

com_os_scorePairs <- intersect(os_scorePairs_tcga$VariableName, os_scorePairs_mar$VariableName)
com_os_scorePairs
```



### Plot survival
Generate Figure 6C.
```{r, fig.height = 6.5, fig.width = 12}
library(gridExtra)

wide2CombLong_tcga <- readRDS(paste0(tcgaPath, "TCGA_Survival_OS_ScoreExpr_wide.RDS"))
wide2CombLong_mar <- readRDS(paste0(marPath, "Marisa_Survival_OS_ScoreExpr_wide.RDS"))

selScorePair_tcga <- wide2CombLong_tcga[
  wide2CombLong_tcga$Comb_Name  %in% 
    com_os_scorePairs, ]

selScorePair_mar <- wide2CombLong_mar[
  wide2CombLong_mar$Comb_Name  %in% 
    com_os_scorePairs, ]

# pdf(
#   paste0(figPath, "OS_Comparison_ScorePairs.pdf"),
#   height = 6.5,
#   width = 12
# )

# i <- "NK_Exh_Bulk--OXPHOS"
for(i in com_os_scorePairs){
  survival_pairPlots(
  data1 = selScorePair_tcga,
  data2 = selScorePair_mar,
  strataName = i,
  strataNameColumn = "Comb_Name",
  strataColumn = "Comb_2status",
  mainTitle1 = "TCGA\n",
  mainTitle2 = "Marisa\n",
  timeCol1  = "OS.time",
  eventCol1 = "OS",
  timeCol2 = "OS.time",
  eventCol2 = "OS",
  nColLegend = 1,
  confInt = F,
  ylabel1 = "OS",
  ylabel2 = "OS",
  CoxPval = " < 0.05",
  cols = cols,
  currentTheme = currentTheme
  )
}
  
# dev.off()

```


### Coef plot
Here we regenarte Figure 6A.
```{r}
cox_OS_2Comb_sig_tcga <- read.csv(
  paste0(
    tcgaPath,
    "TCGA_COAD_RUV_Cox_OS_2ScorePairs_significant.csv"
  ),
  stringsAsFactors = F,
  check.names = F
)

cox_OS_2Comb_sig_mar <- read.csv(
  paste0(
    marPath,
    "Marisa_Cox_OS_2ScorePairs_significant2.csv"
  ),
  stringsAsFactors = F,
  check.names = F
)


dd_tcga <- cox_OS_2Comb_sig_tcga[grepl("DDR|IL6_JAK_STAT3|TGFb_Signaling",
                                       cox_OS_2Comb_sig_tcga$VariableName),
                                 c("VariableName",
                                   "variable",
                                   "exp(coef)",
                                   "lower .95",
                                   "upper .95",
                                   "z",
                                   "Pr(>|z|)")]


dd_mar <- cox_OS_2Comb_sig_mar[grepl("DDR|IL6_JAK_STAT3|TGFb_Signaling",
                                       cox_OS_2Comb_sig_mar$VariableName),
                                 c("VariableName",
                                   "variable",
                                   "exp(coef)",
                                   "lower .95",
                                   "upper .95",
                                   "z",
                                   "Pr(>|z|)")]

colnames(dd_tcga) <- colnames(dd_mar) <-
  c("VariableName",
    "term",
    "estimate",
    "conf.low",
    "conf.high",
    "z",
    "p-value")


dd_tcga <- dd_tcga[order(dd_tcga$estimate), ]
dd_mar <- dd_mar[order(dd_mar$estimate), ]


p1 <- ggstatsplot::ggcoefstats(
  x = dd_tcga,
  output = "plot",
  statistic = "z",
  exponentiate = T,
  # title = "TCGA (OS)", 
  xlab = "exp(coef)",
  ylab = ""
)

p2 <- ggstatsplot::ggcoefstats(
  x = dd_mar,
  output = "plot",  
  statistic = "z",
  exponentiate = T,
  # title = "Marisa (OS)", 
  xlab = "exp(coef)",
  ylab = ""
) 


# png(
#   paste0(figPath, "OS_Comparison_ScorePairs_CoefPlot.png"),
#   height = 2.2,
#   width = 8,
#   unit = "in",
#   res = 400
# )

grid.arrange(p1, p2,
             ncol = 2)
# dev.off()



```


## Extreme Score pairs

```{r}

coxMar_OS_2Comb_Extremes_sig <- 
  read.csv(
    paste0(marPath, "Marisa_Cox_OS_ExtremeScorePairs_significant.csv"),
    stringsAsFactors = F,
    check.names = F
  )

coxTCGA_OS_2Comb_Extremes_sig <-
  read.csv(
    paste0(tcgaPath, "TCGA_Cox_OS_ExtremeScorePairs_significant.csv"),
    stringsAsFactors = F,
    check.names = F
  )



comExtreme <- intersect(coxTCGA_OS_2Comb_Extremes_sig$VariableName, 
          coxMar_OS_2Comb_Extremes_sig$VariableName)
# "CD8_Exh_Bulk--NK_Trm_Bulk" "NK_Trm_Bulk--NK_Exh_Bulk" 

marOnlyExtreme <- coxMar_OS_2Comb_Extremes_sig$VariableName[
  ! coxMar_OS_2Comb_Extremes_sig$VariableName %in% 
    coxTCGA_OS_2Comb_Extremes_sig$VariableName
]

tcgaOnlyExtreme <- coxTCGA_OS_2Comb_Extremes_sig$VariableName[
  ! coxTCGA_OS_2Comb_Extremes_sig$VariableName %in% 
    coxMar_OS_2Comb_Extremes_sig$VariableName
]


```

### Extreme scores significant in both TCGA  and Marisa
Regenerate Figure 8B.
```{r}

##----- look at the extreme scores significant in both TCGA  and Marisa

selScorePair_tcga <- wide2CombLong_tcga[
  wide2CombLong_tcga$Comb_Name %in%  comExtreme &
    wide2CombLong_tcga$Comb_2status %in%  selComb, ]


selScorePair_mar <-
  wide2CombLong_mar[
    wide2CombLong_mar$Comb_Name  %in%  comExtreme &
      wide2CombLong_mar$Comb_2status %in%  selComb,]


# pdf(
#   paste0(figPath, "OS_Comparison_ExtremeScorePairs_signifBoth.pdf"),
#   height = 5.5,
#   width = 11.5
# )

for(i in unique(comExtreme)){
    survival_pairPlots(
  data1 = selScorePair_tcga,
  data2 = selScorePair_mar,
  strataName = i,
  strataNameColumn = "Comb_Name",
  strataColumn = "Comb_2status",
  mainTitle1 = "TCGA\n",
  mainTitle2 = "Marisa\n",
  timeCol1 = "OS.time",
  eventCol1 = "OS",
  timeCol2 = "OS.time",
  eventCol2 = "OS",
  nColLegend = 1,
  confInt = F,
  ylabel1 = "OS",
  ylabel2 = "OS",
  CoxPval = " < 0.05",
  cols = cols,
  currentTheme = currentTheme
  )
}

# dev.off()

```

### Extreme scores significant only in TCGA
```{r}

##----- look at the extreme scores significant only in TCGA

selScorePair_tcga <- wide2CombLong_tcga[
  wide2CombLong_tcga$Comb_Name %in%  tcgaOnlyExtreme &
    wide2CombLong_tcga$Comb_2status %in%  selComb, ]


selScorePair_mar <-
  wide2CombLong_mar[
    wide2CombLong_mar$Comb_Name  %in%  tcgaOnlyExtreme &
      wide2CombLong_mar$Comb_2status %in%  selComb,]


# pdf(
#   paste0(figPath, "OS_Comparison_ExtremeScorePairs_signifOnlyTCGA.pdf"),
#   height = 5.5,
#   width = 11.5
# )

for(i in unique(tcgaOnlyExtreme)){
# for(i in unique(comExtreme)){
    survival_pairPlots(
  data1 = selScorePair_tcga,
  data2 = selScorePair_mar,
  strataName = i,
  strataNameColumn = "Comb_Name",
  strataColumn = "Comb_2status",
  mainTitle1 = "TCGA\n",
  mainTitle2 = "Marisa\n",
  timeCol1 = "OS.time",
  eventCol1 = "OS",
  timeCol2 = "OS.time",
  eventCol2 = "OS",
  nColLegend = 1,
  confInt = F,
  ylabel1 = "OS",
  ylabel2 = "OS",
  CoxPval = " < 0.05 in TCGA",
  cols = cols,
  currentTheme = currentTheme
  )
}

# dev.off()
```

### Extreme scores significant only in Marisa
```{r}
##----- look at the extreme scores significant only in Marisa

selScorePair_tcga <- wide2CombLong_tcga[
  wide2CombLong_tcga$Comb_Name %in%  marOnlyExtreme &
    wide2CombLong_tcga$Comb_2status %in%  selComb, ]


selScorePair_mar <-
  wide2CombLong_mar[
    wide2CombLong_mar$Comb_Name  %in%  marOnlyExtreme &
      wide2CombLong_mar$Comb_2status %in%  selComb,]


# pdf(
#   paste0(figPath, "OS_Comparison_ExtremeScorePairs_signifOnlyMarisa.pdf"),
#   height = 5.5,
#   width = 11.5
# )

for(i in unique(marOnlyExtreme)){
    survival_pairPlots(
  data1 = selScorePair_tcga,
  data2 = selScorePair_mar,
  strataName = i,
  strataNameColumn = "Comb_Name",
  strataColumn = "Comb_2status",
  mainTitle1 = "TCGA\n",
  mainTitle2 = "Marisa\n",
  timeCol1 = "OS.time",
  eventCol1 = "OS",
  timeCol2 = "OS.time",
  eventCol2 = "OS",
  nColLegend = 1,
  confInt = F,
  ylabel1 = "OS",
  ylabel2 = "OS",
  CoxPval = " < 0.05 in Marisa",
  cols = cols,
  currentTheme = currentTheme
  )
}

# dev.off()
```


# Compare PFI (TCGA) and RFS (Marisa)
## Score pairs
Significant score pairs common in both data:

 [1] "CD8_Res_Bulk--OXPHOS"       
 [2] "NK_Res_Bulk--CD8_Exh_Bulk"  
 [3] "NK_Res_Bulk--CD8NK_Exh_Bulk"
 [4] "NK_Res_Bulk--Epi_Thiery"    
 [5] "NK_Res_Bulk--HPX_EGF_EMT"   
 [6] "NK_Res_Bulk--Peroxisome"    
 [7] "NK_Res_Bulk--TP53_signaling"
 [8] "All_Res_Bulk--OXPHOS"       
 [9] "CD8NK_Res_Bulk--TP53_neg"   
[10] "CD8_Exh_Bulk--NK_Res_Bulk"  
[11] "CD8NK_Exh_Bulk--NK_Res_Bulk"
[12] "CD8NK_Exh_Bulk--DDR" 

```{r}
rfs_scorePairs_mar <- read.csv(paste0(marPath, "Marisa_Cox_RFS_2ScorePairs_significant.csv"), 
         stringsAsFactors = F, 
         check.names = F)

pfi_scorePairs_tcga <- read.csv(paste0(tcgaPath, "TCGA_COAD_RUV_Cox_PFI_2ScorePairs_significant.csv"), 
         stringsAsFactors = F, 
         check.names = F)

com_pfi_scorePairs <- intersect(rfs_scorePairs_mar$VariableName, pfi_scorePairs_tcga$VariableName)
com_pfi_scorePairs
## on
```


### Plot survival
Generate Figure 7C, along with survival curves for other significant score pairs.
```{r}
library(gridExtra)
wide2CombLong_tcga <- readRDS(paste0(tcgaPath, "TCGA_Survival_PFI_ScoreExpr_wide.RDS"))
# wide2CombLong_tcga$PFI.time <- wide2CombLong_tcga$PFI.time/12

wide2CombLong_mar <- readRDS(paste0(marPath, "Marisa_Survival_RFS_ScoreExpr_wide.RDS"))

selScorePair_tcga <- wide2CombLong_tcga[
  wide2CombLong_tcga$Comb_Name  %in% 
    com_pfi_scorePairs, ]

selScorePair_mar <- wide2CombLong_mar[
  wide2CombLong_mar$Comb_Name  %in% 
    com_pfi_scorePairs, ]

# pdf(
#   paste0(figPath, "PFI_RFS_Comparison_ScorePairs_signifBoth.pdf"),
#   height = 6.5,
#   width = 12
# )

for(i in com_pfi_scorePairs){
  survival_pairPlots(
  data1 = selScorePair_tcga,
  data2 = selScorePair_mar,
  strataName = i,
  strataNameColumn = "Comb_Name",
  strataColumn = "Comb_2status",
  mainTitle1 = "TCGA\n",
  mainTitle2 = "Marisa\n",
  timeCol1  = "PFI.time",
  eventCol1 = "PFI",
  timeCol2 = "RFS.time",
  eventCol2 = "RFS",
  nColLegend = 1,
  confInt = F,
  ylabel1 = "PFI",
  ylabel2 = "RFS",
  CoxPval = " < 0.05",
  cols = cols,
  currentTheme = currentTheme
  )
}
  
# dev.off()

```

### Coef plot
Generate Figure 7A.
```{r}

cox_pfi_2Comb_sig_tcga <- read.csv(
  paste0(
    tcgaPath,
    "TCGA_COAD_RUV_Cox_PFI_2ScorePairs_significant.csv"
  ),
  stringsAsFactors = F,
  check.names = F
)

cox_rfs_2Comb_sig_mar <- read.csv(
  paste0(
    marPath,
    "Marisa_Cox_RFS_2ScorePairs_significant.csv"
  ),
  stringsAsFactors = F,
  check.names = F
)

comVariables <- intersect(cox_rfs_2Comb_sig_mar$VariableName, cox_pfi_2Comb_sig_tcga$VariableName)

dd_tcga <- cox_pfi_2Comb_sig_tcga[
  cox_pfi_2Comb_sig_tcga$VariableName %in%  comVariables,
                                 c("VariableName",
                                   "variable",
                                   "exp(coef)",
                                   "lower .95",
                                   "upper .95",
                                   "z",
                                   "Pr(>|z|)")]



dd_mar <- cox_rfs_2Comb_sig_mar[
  cox_rfs_2Comb_sig_mar$VariableName  %in%  comVariables,
                                 c("VariableName",
                                   "variable",
                                   "exp(coef)",
                                   "lower .95",
                                   "upper .95",
                                   "z",
                                   "Pr(>|z|)")]

colnames(dd_tcga) <- colnames(dd_mar) <-
  c("VariableName",
    "term",
    "estimate",
    "conf.low",
    "conf.high",
    "z",
    "p-value")

## remove reciprocal duplicated term
dd_tcga <- dd_tcga[
  ! dd_tcga$term  %in% "High CD8NK_Exh_Bulk & Low DDR", ]

dd_tcga <- dd_tcga[
  ! dd_tcga$term  %in% "Low NK_Res_Bulk & High CD8NK_Exh_Bulk", ]
# 
# ## remove reciprocal duplicated term
dd_mar <- dd_mar[
  ! dd_mar$term  %in% "High NK_Res_Bulk & Low CD8NK_Exh_Bulk", ]


dd_tcga <- dd_tcga[order(dd_tcga$estimate), ]
dd_mar <- dd_mar[order(dd_mar$estimate), ]


p1 <- ggstatsplot::ggcoefstats(
  x = dd_tcga,
  output = "plot",
  statistic = "z",
  exponentiate = T,
  # title = "TCGA (OS)", 
  xlab = "exp(coef)",
  ylab = ""
)


# rownames(dd_mar) <- dd_mar$VariableName

p2 <- ggstatsplot::ggcoefstats(
  # x = dd_mar[unique(dd_tcga$VariableName), ],
  x = dd_mar,
  output = "plot",  
  statistic = "z",
  exponentiate = T,
  # title = "Marisa (OS)", 
  xlab = "exp(coef)",
  ylab = ""
) 


# png(
#   paste0(figPath, "PFI_Comparison_ScorePairs_CoefPlot.png"),
#   height = 3,
#   width = 8,
#   unit = "in",
#   res = 400
# )

grid.arrange(p1, p2,
             ncol = 2)
# dev.off()

```




## Extreme Score pairs
There is no significant extreme scores that relates to only Marisa. Therea re some that are common and some that are specific to TCGA.
```{r}

coxMar_rfs_2Comb_Extremes_sig <- read.csv(
          paste0(marPath, "Marisa_Cox_RFS_ExtremeScorePairs_significant.csv"), 
          stringsAsFactors = F, check.names = F)

coxTCGA_pfi_2Comb_Extremes_sig <- read.csv(
          paste0(tcgaPath, "TCGA_Cox_PFI_ExtremeScorePairs_significant.csv"), 
          stringsAsFactors = F, check.names = F)



comExtreme <- intersect(coxTCGA_pfi_2Comb_Extremes_sig$VariableName, 
          coxMar_rfs_2Comb_Extremes_sig$VariableName)
# "CD8_Exh_Bulk--NK_Res_Bulk" "NK_Res_Bulk--NK_Exh_Bulk" 


tcgaOnlyExtreme <- coxTCGA_pfi_2Comb_Extremes_sig$VariableName[
  ! coxTCGA_pfi_2Comb_Extremes_sig$VariableName %in% 
    coxMar_rfs_2Comb_Extremes_sig$VariableName
]

# [1] "CD8_Res_Bulk--CD8_Exh_Bulk"     "CD4_Res_Bulk--NK_Exh_Bulk"      "CD8_Res_Bulk--NK_Exh_Bulk"     
# [4] "CD4_Res_Bulk--CD8_Exh_Bulk"     "CD4_Res_Bulk--CD4_Exh_Bulk"     "CD8NK_Exh_Bulk--CD8NK_Res_Bulk"


```

### Extreme scores significant in both data 
Generate Figure 8C and Suppl Figure 14.
```{r}

##----- look at the extreme scores significant in both TCGA  and Marisa

selScorePair_tcga <- wide2CombLong_tcga[
  wide2CombLong_tcga$Comb_Name %in%  comExtreme &
    wide2CombLong_tcga$Comb_2status %in%  selComb, ]


selScorePair_mar <-
  wide2CombLong_mar[
    wide2CombLong_mar$Comb_Name  %in%  comExtreme &
      wide2CombLong_mar$Comb_2status %in%  selComb,]


# pdf(
#   paste0(figPath, "PFI_RFS_Comparison_ExtremeScorePairs_SignifBoth.pdf"),
#   height = 5.5,
#   width = 11.5
# )

for(i in unique(comExtreme)){
    survival_pairPlots(
  data1 = selScorePair_tcga,
  data2 = selScorePair_mar,
  strataName = i,
  strataNameColumn = "Comb_Name",
  strataColumn = "Comb_2status",
  mainTitle1 = "TCGA\n",
  mainTitle2 = "Marisa\n",
  timeCol1 = "PFI.time",
  eventCol1 = "PFI",
  timeCol2 = "RFS.time",
  eventCol2 = "RFS",
  nColLegend = 1,
  confInt = F,
  ylabel1 = "PFI",
  ylabel2 = "RFS",
  CoxPval = " < 0.05",
  cols = cols,
  currentTheme = currentTheme
  )
}

# dev.off()


```

### Extreme scores significant in TCGA only
```{r}

selScorePair_tcga <- wide2CombLong_tcga[
  wide2CombLong_tcga$Comb_Name %in%  tcgaOnlyExtreme &
    wide2CombLong_tcga$Comb_2status %in%  selComb, ]


selScorePair_mar <-
  wide2CombLong_mar[
    wide2CombLong_mar$Comb_Name  %in%  tcgaOnlyExtreme &
      wide2CombLong_mar$Comb_2status %in%  selComb,]

# 
# pdf(
#   paste0(figPath, "PFI_RFS_Comparison_ExtremeScorePairs_SignifOnlyTCGA.pdf"),
#   height = 5.5,
#   width = 11.5
# )

for(i in unique(tcgaOnlyExtreme)){
    survival_pairPlots(
  data1 = selScorePair_tcga,
  data2 = selScorePair_mar,
  strataName = i,
  strataNameColumn = "Comb_Name",
  strataColumn = "Comb_2status",
  mainTitle1 = "TCGA\n",
  mainTitle2 = "Marisa\n",
  timeCol1 = "PFI.time",
  eventCol1 = "PFI",
  timeCol2 = "RFS.time",
  eventCol2 = "RFS",
  nColLegend = 1,
  confInt = F,
  ylabel1 = "PFI",
  ylabel2 = "RFS",
  CoxPval = " < 0.05 in TCGA",
  cols = cols,
  currentTheme = currentTheme
  )
}

# dev.off()
```


      
# Session information
Here are the list of tools and packages (along with their versions) used in this document. 
```{r}
sessionInfo()
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 598px;"></div>
    
      


